pyinstaller-poetry:
  update_version_in:
    - opsiconfd/__init__.py
  one_file: no
  hidden_imports:
    all:
      - ipaddress
      - colorsys
      - gunicorn.glogging
      - uvicorn.workers
      - uvicorn.loops
      - uvicorn.loops.auto
      - uvicorn.loops.uvloop
      - uvicorn.lifespan
      - uvicorn.lifespan.on
      - uvicorn.protocols
      - uvicorn.protocols.http
      - uvicorn.protocols.http.h11_impl
      - uvicorn.protocols.http.httptools_impl
      - uvicorn.protocols.websockets
      - uvicorn.protocols.websockets.auto
      - pydantic.color
      - pydantic.validators
      - pydantic.datetime_parse
      - OPSI.Backend.Depotserver
      - OPSI.Backend.DHCPD
      - OPSI.Backend.File
      - OPSI.Backend.HostControl
      - OPSI.Backend.HostControlSafe
      - OPSI.Backend.JSONRPC
      - OPSI.Backend.MySQL
      - OPSI.Backend.OpsiPXEConfd
      - OPSI.Backend.Replicator
      - OPSI.Backend.SQLite
  scripts:
    - script: run-opsiconfd
      binaries:
        - opsiconfd
  data_files:
    - src: opsiconfd_data/**/*
      dst: opsiconfd_data
  dirname: opsiconfd
  after_script:
    - mv dist/opsiconfd/site-packages/wsgidav dist/opsiconfd/wsgidav
    - find dist/opsiconfd -iname "*.c" -delete
    - find dist/opsiconfd -iname "*.h" -delete
    - rm -r dist/opsiconfd/site-packages/Crypto/SelfTest

package:
  name: opsiconfd
  type: binary
  systemd: yes
  dependencies: []
  source_script:
    - pyi_src="${SRC}"
    - if [ -e "${SRC}/dist/opsiconfd/opsiconfd" ]; then pyi_src="${SRC}/dist"; fi
    - mkdir -p ${DST}/rootfs/etc/opsi
    - mkdir -p ${DST}/rootfs/usr/bin
    - mkdir -p ${DST}/rootfs/usr/lib
    - mkdir -p ${DST}/rootfs/usr/share/opsiconfd
    - mkdir -p ${DST}/rootfs/var/log/opsi/opsiconfd
    - mkdir -p ${DST}/systemd_units
    - cp -a ${pyi_src}/opsiconfd ${DST}/rootfs/usr/lib/
    - echo "#!/bin/sh"               > ${DST}/rootfs/usr/bin/opsiconfd
    - echo "cd /usr/lib/opsiconfd"  >> ${DST}/rootfs/usr/bin/opsiconfd
    - echo "exec ./opsiconfd \$@"   >> ${DST}/rootfs/usr/bin/opsiconfd
    - chmod 755 ${DST}/rootfs/usr/bin/opsiconfd
    - mv ${DST}/rootfs/usr/lib/opsiconfd/opsiconfd_data/static ${DST}/rootfs/usr/share/opsiconfd/
    - mv ${DST}/rootfs/usr/lib/opsiconfd/opsiconfd_data/opsiconfd.conf ${DST}/rootfs/etc/opsi/
    - mv ${DST}/rootfs/usr/lib/opsiconfd/opsiconfd_data/opsiconfd.service ${DST}/systemd_units/
    - rm -r ${DST}/rootfs/usr/lib/opsiconfd/opsiconfd_data
  postinst_script: opsiconfd_data/postinst

changelog:
  next:
    - Full rewrite using Starlette, FastAPI, ASGI, uvloop, Redis
