#!/usr/bin/make -f
# -*- makefile -*-

clean:
	dh_testdir
	dh_clean
	rm -f debian/files || true

install:
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	
	# copy pyinstaller files
	cp -a opsiconfd debian/opsiconfd/usr/lib/

	# create script in /usr/bin
	echo "#!/bin/sh" > debian/opsiconfd/usr/bin/opsiconfd
	echo "cd /usr/lib/opsiconfd" >> debian/opsiconfd/usr/bin/opsiconfd
	echo "./opsiconfd \$$@" >> debian/opsiconfd/usr/bin/opsiconfd
	chmod 755 debian/opsiconfd/usr/bin/opsiconfd

	# copy static
	cp -a static debian/opsiconfd/usr/share/opsiconfd/
	find debian/opsiconfd/usr/share/opsiconfd/static -type f -exec chmod 644 "{}" \;
	find debian/opsiconfd/usr/share/opsiconfd/static -type d -exec chmod 755 "{}" \;

	# create config file
	echo "# For available options see: opsiconfd --help"  > /etc/opsi/opsiconfd.conf
	echo "# config example:"                             >> /etc/opsi/opsiconfd.conf
	echo "# log-level = 5"                               >> /etc/opsi/opsiconfd.conf
	chmod 644 /etc/opsi/opsiconfd.conf
	
	dh_install

override_dh_auto_install:
	dh_auto_install
	dh_systemd_enable || true
	dh_systemd_start || true

binary-indep: install
	dh_testdir -i
	dh_installdebconf
	dh_installchangelogs -i
	dh_systemd_enable
	dh_systemd_start
	dh_md5sums
	dh_gencontrol
	dh_installdeb
	dh_builddeb

binary: binary-indep
build:
.PHONY: clean binary-indep binary install build
