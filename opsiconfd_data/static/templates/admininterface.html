<!DOCTYPE html>
<html>

<head>
	<title>opsiconfd admin page</title>
	<link rel="stylesheet" type="text/css" href="/static/opsiconfd.css">
	<link rel="stylesheet" type="text/css" href="/static/xterm/xterm.css" />

	<script src="/static/javascript/common.js"></script>
	<script src="/static/javascript/admininterface.js"></script>
	<script src="/static/javascript/memory_profiler.js"></script>
	<script src="/static/javascript/msgpack.js"></script>
	<script src="/static/javascript/log_viewer.js"></script>
	<script src="/static/xterm/xterm.js"></script>
	<script src="/static/xterm/xterm-addon-attach.js"></script>
	<script src="/static/xterm/xterm-addon-fit.js"></script>
	<script src="/static/xterm/xterm-addon-search.js"></script>
	<script src="/static/xterm/xterm-addon-web-links.js"></script>

	<script>
		var reloadTimer;
		var JSONRPCInterface = JSON.parse('{{interface|tojson}}');

		function onLoad() {
			setTimeout(monitorSession, 5000);

			let input = document.getElementById("redis-cmd");

			input.onkeyup = function (event) {
				// Number 13 is the "Enter" key on the keyboard
				if (event.keyCode === 13) {
					document.getElementById("redis-button").click();
				}
			};

			document.getElementById("json-result").style.visibility = 'hidden';
			document.getElementById("text-result").style.visibility = 'hidden';
			document.getElementById("redis-result").style.visibility = 'hidden';

			document.getElementById("jsonrpc-result").style.visibility = 'hidden';
			document.getElementById("jsonrpc-request").style.visibility = 'hidden';
			document.getElementById("memory-info").style.visibility = 'hidden';

			let tab = window.location.hash.replace(/#/, "");
			if (!tab) tab = "info";

			//console.info("onload: " + tab);
			openTab(tab);
		}

		function stopReloadTimer() {
			if (reloadTimer) {
				clearInterval(reloadTimer);
				reloadTimer = null;
			}
		}

		function createParamInputs() {
			let value = document.getElementById("method-select").value;
			let table = document.getElementById("jsonrpc-request-table");
			var elements = table.getElementsByClassName("param");
			while (elements.length > 0) {
				table.removeChild(elements[0]);
			}
			JSONRPCInterface.forEach(method => {
				if (method.name == value) {
					method.params.forEach(param => {
						let tr = document.createElement("tr");
						tr.className = "param";
						tr.innerHTML = "\
							<td align=\"left\"><label>" + param + ": </label></td> \
							<td><input type=\"text\" id=\"" + param + "\" name=\"" + param + "\" oninput=\"changeRequestJSON(this.name,this.value)\" /></td> \
						";
						table.appendChild(tr);
					});
					document.getElementById("jsonrpc-method-doc").innerHTML = method.doc;
				}
			});
			changeRequestJSON();
		}

		function openTab(tabName) {
			stopReloadTimer();
			stopLog();
			stopTerminal();

			if (tabName == "rpc-infos") {
				loadRPCTable("rpc_num", false);
			}
			else if (tabName == "clients") {
				loadSessionTable();
				loadClientTable();
				reloadTimer = setInterval(loadSessionTable, 5000);
			}
			else if (tabName == "depots") {
				loadLockedProductsTable();
			}
			else if (tabName == "rpc-interface") {
				createParamInputs();
			}
			else if (tabName == "redisInfo") {
				loadRedisInfo();
			}
			else if (tabName == "info") {
				loadInfo();
			}
			else if (tabName == "addons") {
				loadAddons();
			}
			else if (tabName == "memory-profiler") {
				loadMemoryInfo();
			}
			else if (tabName == "log-viewer") {
				startLog();
			}
			else if (tabName == "terminal") {
				setTimeout(startTerminal, 500);
			}
			else if (tabName == "licensing") {
				loadLicensingInfo();
			}

			// Get all elements with class="tabcontent" and hide them
			let tabcontent = document.getElementsByClassName("tabcontent");
			for (let i = 0; i < tabcontent.length; i++) {
				tabcontent[i].style.display = "none";
			}

			// Get all elements with class="tablinks" and remove the class "active"
			let tablinks = document.getElementsByClassName("tablink");
			for (let i = 0; i < tablinks.length; i++) {
				tablinks[i].classList.remove("active");
			}
			let tabLink = document.getElementById("tablink-" + tabName);
			if (tabLink) {
				tabLink.classList.add("active");
			}

			// Show the current tab, and add an "active" class to the button that opened the tab
			document.getElementById("tab-" + tabName).style.display = "inherit";
		}
	</script>
</head>

<body onload="onLoad();">
	<div class="header">
		<div style="width: 120px; float: left">
			<img id="interface-logo" src="/static/opsi_logo.png" alt="opsi logo">
		</div>
		<div style="overflow: hidden; display: flex; height: 100%;">
			<div style="display: inline-block; align-self: flex-end;">
				<h1>opsiconfd {{opsi_version}} running on {{node_name}} ({{username}})</h1>
			</div>
		</div>
	</div>
	<div id="content" class="content">

		<div class="tab">
			<a href="#info" id="tablink-info" class="tablink" onclick="openTab('info');">Info</a>
			<a href="#clients" id="tablink-clients" class="tablink" onclick="openTab('clients');">Clients</a>
			<a href="#depots" id="tablink-depots" class="tablink" onclick="openTab('depots');">Depots</a>
			<a href="#rpc-infos" id="tablink-rpc-infos" class="tablink" onclick="openTab('rpc-infos');">RPC-Infos</a>
			{% if "rpc-interface" not in disabled_features %}
			<a href="#rpc-interface" id="tablink-rpc-interface" class="tablink"
				onclick="openTab('rpc-interface');">RPC-Interface</a>
			{% endif %}
			<a href="#redis-interface" id="tablink-redis-interface" class="tablink"
				onclick="openTab('redis-interface');">Redis-Interface</a>
			<a href="#addons" id="tablink-addons" class="tablink" onclick="openTab('addons');">Addons</a>
			<a href="#log-viewer" id="tablink-log-viewer" class="tablink" onclick="openTab('log-viewer');">Log
				Viewer</a>
			{% if "terminal" not in disabled_features %}
			<a href="#terminal" id="tablink-terminal" class="tablink" onclick="openTab('terminal');">Terminal</a>
			{% endif %}
			<a href="#licensing" id="tablink-licensing" class="tablink" onclick="openTab('licensing');">Licensing</a>
			<!--
			<a href="#memory-profiler" id="tablink-memory-profiler" class="tablink" onclick="openTab('memory-profiler');">Memory Profiler</a>
			-->
			<a href="/admin/grafana" target="_blank" class="tablink">Grafana</a>
			<a href="/dav" target="_blank" class="tablink">WebDAV</a>
			<a href="/public" target="_blank" class="tablink">Public</a>
			<a href="#links" id="tablink-links" class="tablink" onclick="openTab('links');">Links</a>
			<a href="#" class="tablink" onclick="logout()">Logout</a>
		</div>

		<div id="tab-clients" class="tabcontent">
			<div class="adminpage-box" id="sessions">
				<h4>Sessions:</h4>
				<div id="session-table-div">
					loading...
				</div>
			</div>

			<div class="adminpage-box" id="blocked-clients">
				<h4>Blocked Clients:</h4>
				<div id="blocked-clients-div">

				</div>
			</div>

			<div class="adminpage-box">
				<h4>Unblock Clients:</h4>
				<table>
					<tr>
						<td align="left"><label>Unblock all clients:</label></td>
						<td></td>
						0 <td><button id="unblock-all-button" onclick="unblockAll()">Execute</button></td>
					</tr>
					<tr>
						<td align="left">Unblock address:</td>
						<td><input id="clientAddr" type="text" name="clientAddr" placeholder="127.0.0.1"></td>
						<td><input type="button" onclick="unblockClient(clientAddr.value)" value="Execute"></td>
					</tr>
					<tr>
						<td align="left">Delete client sessions:</td>
						<td><input id="sessionAddr" type="text" name="sessionAddr" placeholder="127.0.0.1"></td>
						<td><input type="button" onclick="deleteClientSessions()" value="Execute"></td>
					</tr>
				</table>
			</div>
			<div id="result">
				<p class="json-result" id="text-result"></p>
			</div>
			<div id="result">
				<pre class="json-result" id="json-result"></pre>
			</div>
		</div>

		<div id="tab-depots" class="tabcontent">
			<div class="adminpage-box" id="sessions">
				<h4>Locked Products:</h4>
				<div id="locked-products-table-div">
					loading...
				</div>
				<input type="button" onclick="unlockAllProducts()" value="Unlock all">
			</div>

		</div>

		<div id="tab-rpc-infos" class="tabcontent">
			<div class="adminpage-box">
				<div id="rpc-table-div">
					loading...
				</div>
			</div>
		</div>

		<div id="tab-rpc-interface" class="tabcontent">
			<div class="adminpage-box">
				<div>
					<div style="float: left">
						<table id="jsonrpc-request-table">
							<tr>
								<td align="left"><label>Method:</label></td>
								<td>
									<select id="method-select" onchange="createParamInputs()">
										{% for method in interface %}
										<option>{{ method.get("name") }}</option>
										{% endfor %}
									</select>
								</td>
							</tr>
						</table>
					</div>
					<div style="overflow: hidden">
						<p id="jsonrpc-method-doc" colspan="2" align="left"></p>
					</div>
				</div>
				<div id="jsonrpc-request-error">
				</div>
			</div>
			<div>
				<pre class="jsonrpc-request" id="jsonrpc-request"></pre>
			</div>
			<button id="jsonrpc-execute-button" onclick="callJSONRPC()">Execute</button>
			<div id="result">
				<p id="jsonrpc-response-info"></p>
				<pre class="jsonrpc-result" id="jsonrpc-result"></pre>
			</div>
		</div>

		<div id="tab-redis-interface" class="tabcontent">
			<div class="adminpage-box">
				<h4>Redis</h4>
				<input type="text" id="redis-cmd" name="redis-cmd" size=50 />
				<button id="redis-button" onclick="callRedis()">Execute</button>
				<button id="redis-button" onclick="loadRedisInfo()">Info+</button>
			</div>
			<div class="adminpage-box">
				<h4>Redis Cache</h4>
				<table>
					<tr>
						<td align="left"><label>Clear cache:</label></td>
						<td></td>
						<td><button id="clear-cache-button" onclick="clearRedisCache()">Execute</button> </td>
					</tr>
					<tr>
						<td align="left">Clear depot cache:</td>
						<td><input id="depotId" type="text" name="depotId" placeholder="myhost.example.com"></td>
						<td><input type="button" onclick="clearRedisCache([depotId.value])" value="Execute"></td>
					</tr>
				</table>
			</div>
			<div id="resultRedis">
				<pre class="redis-result" id="redis-result"></pre>
			</div>
		</div>

		<div id="tab-addons" class="tabcontent">
			<div class="adminpage-box">
				<h4>Addons:</h4>
				<div id="addon-table-div">
					loading...
				</div>
				<div style="margin-top: 25px">
					<input id="addon-file" type="file" name="addon-file" />
					<button id="addon-upload" onclick="installAddon()">Install addon</button>
				</div>
			</div>
			<div id="alerts"></div>
		</div>

		<div id="tab-info" class="tabcontent">
			<h3>opsiconfd info</h3>
			<div class="adminpage-box">
				<h5 style="margin: 10px">Number of depot servers: {{num_servers}}</h4>
					<h5 style="margin: 10px">Number of clients: {{num_clients}}</h4>
			</div>
			<div class="adminpage-box">
				<h4 style="margin: 10px">opsi CA:</h4>
				<div id="general-info-opsi-ca">
					<table style="margin-left: 20px;margin-bottom: 0px;">
						<tr>
							<td>issuer:</td>
							<td>{{ca_info.issuer.C}}, {{ca_info.issuer.ST}}, {{ca_info.issuer.L}},
								{{ca_info.issuer.OU}}, {{ca_info.issuer.CN}}</td>
						</tr>
						<tr>
							<td>subject:</td>
							<td>{{ca_info.subject.C}}, {{ca_info.subject.ST}}, {{ca_info.subject.L}},
								{{ca_info.subject.OU}}, {{ca_info.subject.CN}}</td>
						</tr>
						<tr>
							<td>serial number:</td>
							<td>{{ca_info.serial_number}}</td>
						</tr>
						<tr>
							<td>not before:</td>
							<td>{{ca_info.not_before}}</td>
						</tr>
						<tr>
							<td>not after:</td>
							<td>{{ca_info.not_after}}</td>
						</tr>
						<tr>
							<td>expires:</td>
							<td>in {{ca_info.expires_in_days}} days</td>
						</tr>
						<tr>
							<td>renewal:</td>
							<td>in {{ca_info.renewal_in_days}} days</td>
						</tr>
						<tr>
							<td colspan="2"><a href="/ssl/opsi-ca-cert.pem">Download as PEM</a></td>
						</tr>
					</table>
				</div>
			</div>
			<div class="adminpage-box">
				<h4 style="margin: 10px">server certificate:</h4>
				<div id="general-info-server-cert">
					<table style="margin-left: 20px;">
						<tr>
							<td>issuer:</td>
							<td>{{cert_info.issuer.C}}, {{cert_info.issuer.ST}}, {{cert_info.issuer.L}},
								{{cert_info.issuer.OU}}, {{cert_info.issuer.CN}}</td>
						</tr>
						<tr>
							<td>subject:</td>
							<td>{{cert_info.subject.C}}, {{cert_info.subject.ST}}, {{cert_info.subject.L}},
								{{cert_info.subject.OU}}, {{cert_info.subject.CN}}</td>
						</tr>
						<tr>
							<td>subjectAltName:</td>
							<td>{{cert_info.alt_names}}</td>
						</tr>
						<tr>
							<td>serial number:</td>
							<td>{{cert_info.serial_number}}</td>
						</tr>
						<tr>
							<td>not before:</td>
							<td>{{cert_info.not_before}}</td>
						</tr>
						<tr>
							<td>not after:</td>
							<td>{{cert_info.not_after}}</td>
						</tr>
						<tr>
							<td>expires:</td>
							<td>in {{cert_info.expires_in_days}} days</td>
						</tr>
						<tr>
							<td>renewal:</td>
							<td>in {{cert_info.renewal_in_days}} days</td>
						</tr>
					</table>
				</div>
			</div>

			<h3 style="margin-top: 25px">opsiconfd config</h3>
			<button style="margin-top: 5px" id="reload-button" onclick="reload()">Service reload</button>
			<div class="adminpage-box">
				<div id="config">
					<pre class="config-values" id="config-values"></pre>
				</div>
			</div>


			<h3>routes</h3>
			<div class="adminpage-box">
				<div id="routes">
					<pre class="route-values" id="route-values"></pre>
				</div>
			</div>
		</div>

		<div id="tab-memory-profiler" class="tabcontent">
			<div class="adminpage-box">

				<!--
				<h4>Memory Usage (pympler)</h4>
				<table>
					<tr>
						<td><button id="take-snapshot-button" onclick="takeMemorySnapshot()">Take Snapshot</button> </td>
						<td><input type="button" onclick="deleteMemorySnapshots()" value="Delete Snapshots"></td>
						<td><input type="button" onclick="deleteMemoryTracker()" value="Delete Tracker"></td>
					</tr>
					<tr>
						<td>s1: <input id="snapshot1" type="number" name="snapshot1" placeholder=1></td>
						<td>s2: <input id="snapshot2" type="number" name="snapshot2" placeholder=-1></td>
						<td><input type="button" onclick="diffMemorySnapshots()" value="Diff Snapshots"></td>
					</tr>
				</table>
				<hr>
				<h4>Memory Usage (guppy3)</h4>
				<table>
					<tr>
						<td><button id="take-snapshot-button" onclick="takeHeapSnapshot()">Take Snapshot</button> </td>
						<td><input type="button" onclick="deleteHeapSnapshots()" value="Delete Snapshots"></td>
					</tr>
					<tr>
						<td>s1: <input id="snapshot1" type="number" name="snapshot1" placeholder=1></td>
						<td>s2: <input id="snapshot2" type="number" name="snapshot2" placeholder=-1></td>
						<td><input type="button" onclick="diffHeapSnapshots()" value="Diff Snapshots"></td>
					</tr>
				</table>
				<hr>
				<h4>Class Tracker</h4>
				<table>
					<tr>
						<td><input id="module-name" type="text" name="module-name" placeholder="module"></td>
					</tr>
					<tr>
						<td><input id="class-name" type="text" name="class-name" placeholder="class"></td>
					</tr>
					<tr>
						<td><input id="description" type="text" name="description" placeholder="description"></td>
						<td><input type="button" onclick="takeClassSnapshot()" value="Take Class Snapshot"></td>
					</tr>
					<tr>

						<td><input type="button" onclick="classSummary()" value="Summary"></td>
						<td><input type="button" onclick="deleteClassTracker()" value="Delete Class Tracker"></td>
					</tr>
				</table>
				-->
				<h4>Memory Profile</h4>
				<label>Max object types: </label>
				<input id="input-objgraph-max-obj-types" type="number" value="25" style="width: 50px" />
				<label>Max objects per type: </label>
				<input id="input-objgraph-max-obj" type="number" value="50" style="width: 50px" />
				<button id="button-objgraph-snapshot-new" onclick="objgraphSnapshot(false)">Take snapshot</button>
				<button id="button-objgraph-snapshot-update" onclick="objgraphSnapshot(true)">Update snapshot</button>
				<br />
				<label>Object id: </label>
				<input id="input-objgraph-obj-id" type="text" />
				<button id="button-objgraph-show-backrefs" onclick="objgraphShowBackrefs()">Show backrefs</button>

				<br /><br />
				<button id="button-tracemalloc-snapshot" onclick="tracemallocSnapshot()">Tracemalloc snapshot</button>
			</div>
			<div class="adminpage-box" id="memory-info">
				<pre class="memory-values" id="memory-values" style="overflow: auto"></pre>
			</div>
		</div>

		<div id="tab-log-viewer" class="tabcontent fitheight">
			<div id="log-settings">
				<div class="log-setting">
					<button class="tab-maximize" onclick="toggleTabMaximize();">Maximize</button>
				</div>
				<div class="log-setting">
					<label for="log-level-filter">Filter by level:</label>
					<input id="log-level-filter" type="number" min="1" max="9" value="9"
						onchange="applyLevelFilter(this.value);">
				</div>
				<div class="log-setting">
					<label for="log-context-filter">Filter by context:</label>
					<input id="log-context-filter" type="text" onchange="applyContextFilter(this.value);" />
				</div>
				<div class="log-setting">
					<label for="log-message-filter">Filter by message:</label>
					<input id="log-message-filter" type="text" onchange="applyMessageFilter(this.value);" />
				</div>
				<div class="log-setting">
					<label for="collapse-all">Collapse multi-line:</label>
					<input type="checkbox" id="collapse-all" onclick="collapseAll(this.checked);" checked>
				</div>
				<div class="log-setting">
					<label for="collapse-all">Auto scroll:</label>
					<input type="checkbox" id="auto-scroll" onclick="setAutoScroll(this.checked);" checked>
				</div>
				<div class="log-setting">
					<label>Font size:</label>
					<button id="decrease-font-size" onclick="changeFontSize(-1);">-</button>
					<button id="increase-font-size" onclick="changeFontSize(+1);">+</button>
				</div>
			</div>
			<div id="log-container" onwheel="if (window.event.deltaY < 0) setAutoScroll(false);">
				<div id="log-line-container" style="font-size: 14px"></div>
				<div id="log-msg-container"></div>
			</div>
		</div>

		<div id="tab-terminal" class="tabcontent fitheight">
			<div id="terminal-control">
				<button class="tab-maximize" style="margin-top: 10px; margin-right: 25px;"
					onclick="toggleTabMaximize();">Maximize</button>
				<button style="margin-top: 10px; margin-right: 25px;"
					onclick="toggleFullscreenTerminal();">Fullscreen</button>

				<label>Font size:</label>
				<button id="decrease-terminal-font-size" onclick="changeTerminalFontSize(-1);">-</button>
				<button id="increase-terminal-font-size" onclick="changeTerminalFontSize(+1);">+</button>
				<label for="terminal-file-upload" class="terminal-file-upload" style="margin-left: 25px;">
					To upload a file to the current working directory, drop it in the terminal window or click here.
				</label>
				<input id="terminal-file-upload" type="file"
					onchange="terminalFileUpload(this.files[0]); this.value='';">
			</div>
			<div id="terminal-xterm">
			</div>
		</div>

		<div id="tab-messagebus" class="tabcontent fitheight">
			<h4>Messagebus</h4>
			<button id="messagebus-connect-disconnect" onclick="messagebusToggleConnect()">Connect</button>
			<div class="adminpage-box" style="display: flex;">
				<div style="flex-basis: 45%; margin-right: 25px">
					Message out:
					<textarea id="messagebus-message-out"></textarea>
					<br />
					<select id="messagebus-message-template-select" style="width: 200px;"
						onchange="messagebusInsertMessageTemplate()">
						<option>Insert message template</option>
						<option>channel_subscription_request</option>
						<option>trace_request</option>
						<option>jsonrpc_request</option>
					</select>
					<button id="messagebus-message-send" onclick="messagebusSendMessage()">Send</button>
				</div>
				<div style="flex-basis: 45%">
					Messages in:
					<textarea id="messagebus-message-in"></textarea>
					<br />
					Autoscroll <input type="checkbox" id="messagebus-message-in-auto-scroll" checked="checked"
						onclick="messagebusToggleAutoScroll()">
					<button id="messagebus-message-in-clear"
						onclick="document.getElementById('messagebus-message-in').innerHTML='';">Clear</button>
				</div>
			</div>
			<div class="adminpage-box" style="width: 900px; height: 420px;">
				<label>Channel:</label><input type="text" id="messagebus-terminal-channel"
					style="width: 300px;"></input>
				<label>Terminal id:</label><input type="text" id="messagebus-terminal-id" style="width: 300px;"></input>
				<button id="messagebus-terminal-connect" onclick="messagebusConnectTerminal()">Connect</button>
				<div id="messagebus-terminal-xterm" style="margin-top: 10px;">
				</div>
			</div>
			<br /><br /><br /><br /><br /><br /><br /><br /><br />
		</div>

		<div id="tab-licensing" class="tabcontent">
			<div id="licensing-info">
			</div>
			<div id="licensing-dates">
			</div>
			<div id="license-upload">
				Upload license files:
				<input type="file" multiple accept=".opsilic" onchange="licenseUpload(this.files); this.value='';">
			</div>
		</div>

		<div id="tab-links" class="tabcontent">
			<ul>
				{% if "webgui" in addons|map(attribute="id") %}
				<li>
					Open the web based management interface <a href="/addons/webgui" target="_blank"
						rel="noopener noreferrer">opsiweb</a>.
				</li>
				{% endif %}
				<li>
					Download the standalone management interface <a href="#"
						onclick="downloadConfiged()">opsi-configed</a>.
				</li>
				<li>
					Open the <a href="https://docs.opsi.org" target="_blank" rel="noopener noreferrer">opsi
						documentation</a>.
				</li>
				<li>
					Visit the <a href="https://forum.opsi.org/index.php" target="_blank" rel="noopener noreferrer">opsi
						forum</a>.
				</li>
			</ul>
		</div>
	</div>
</body>

</html>