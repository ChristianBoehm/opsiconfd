<html>
<head>
	<title>Interface</title>
	<link rel="stylesheet" type="text/css" href="/static/opsiconfd.css">
	<script>
		function onLoad() {
			document.getElementById("jsonrpc-result").style.visibility = 'hidden';
			document.getElementById("jsonrpc-request").style.visibility = 'hidden';
			createParamInputs();
		}
		function createParamInputs() {
			let value = document.getElementById("method-select").value;
			// !!! use '' because json uses "" !!! 
			let interface = '{{interface|tojson}}';
	
			interface = JSON.parse(interface);
			// console.log("get_method: " + value);
			
			let table = document.getElementById("jsonrpc-request-table");
			var elements = table.getElementsByClassName("param");
			while(elements.length > 0){
				table.removeChild(elements[0]);
			}
			interface.forEach(method => {
				if (method.name == value) {
					method.params.forEach(param => {
						let tr = document.createElement("tr");
						tr.className = "param";
						tr.innerHTML = "\
							<td align=left><label>" + param + ": </label></td> \
							<td><input type=\"text\" id=\"" + param + "\" name=\"" + param + "\" oninput=\"changeRequestJSON(this.name,this.value)\" /></td> \
						";
						table.appendChild(tr);
					});
				}
			});
			changeRequestJSON();
		}
	
		function createRequestJSON() {
			let apiJSON = {
				"id": 1,
				"method": "",
				"params": [
					[],
					{}
				]
			}
	
			let option = document.getElementById("method-select");
			let method = option.options[option.selectedIndex].text;
			let inputs = document.getElementsByTagName("input");
			let parameter = [];
	
			apiJSON.method = method;
	
			try {
				for (i = 0; i < inputs.length; i++) {
					let name = inputs[i].name.trim();
					let value = inputs[i].value.trim();
	
					if (value) {
						parameter.push(JSON.parse(value));
					}
					else {
						if (name.indexOf("*", 1) == -1) {
							parameter.push(null);
						}
					} 
				}
			} catch (e) {
				if (e instanceof SyntaxError) {
					console.log("JSON not valid... " + e);
				} else {
					console.log(e);
				}
			}
	
			apiJSON.params = parameter;
			return apiJSON;
		}
	
		function changeRequestJSON(name, value) {
			let apiJSON = createRequestJSON();
			outputToHTML(apiJSON, "jsonrpc-request");
		}
	
		function callJSONRPC() {
			let inputs = document.getElementsByTagName("input");
			for (i = 0; i < inputs.length; i++) {
				let name = inputs[i].name.trim();
				let value = inputs[i].value.trim();
	
				if (!value && name.substr(0, 1) != "*") {
	
					alert("mandatory field empty");
					return {
						"error": "mandatory field empty"
					};
				}
			}
	
			let apiJSON = createRequestJSON();
			// console.log("apiJSON: ");
			// console.log(apiJSON);
			// console.log(window.location.protocol);
			// console.log(window.location.host);
			// console.log(window.location.hostname);
			// console.log(window.location.port);
			let request = new XMLHttpRequest();
			request.open("POST", "/rpc");
			
			request.addEventListener('load', function (event) {
				document.getElementById("jsonrpc-execute-button").disabled = false;
				if (request.status >= 200 && request.status < 300) {
					result = request.responseText
					result = JSON.parse(result);
					outputToHTML(result, "jsonrpc-result");
					return result;
	
				} else {
					console.warn(request.statusText, request.responseText);
					return request.statusText;
				}
			});
			document.getElementById("jsonrpc-execute-button").disabled = true;
			request.send(JSON.stringify(apiJSON));
		}
	
		function outputToHTML(json, id) {
			jsonStr = JSON.stringify(json, undefined, 2);
			jsonStr = syntaxHighlight(jsonStr);
			document.getElementById(id).style.visibility = 'visible'
			document.getElementById(id).innerHTML = jsonStr;
		}
	
		// https://stackoverflow.com/questions/4810841/pretty-print-json-using-javascript
		function syntaxHighlight(json) {
			if (typeof json != 'string') {
				json = JSON.stringify(json, undefined, 2);
			}
			json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			return json.replace(
				/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
				function (match) {
					var cls = 'json_number';
					if (/^"/.test(match)) {
						if (/:$/.test(match)) {
							cls = 'json_key';
						} else {
							cls = 'json_string';
						}
					} else if (/true|false/.test(match)) {
						cls = 'json_boolean';
					} else if (/null/.test(match)) {
						cls = 'json_null';
					}
					return '<span class="' + cls + '">' + match + '</span>';
				});
		}
	
		function decode(html) {
			var txt = document.createElement('textarea');
			txt.innerHTML = html;
			return txt.value;
		}
	
	</script>
</head>

<body onload="onLoad();">
	<div class="content">
		<img id="interface-logo" src="/static/opsi_logo.png" alt="opsi logo">
		<div class="interface-container">
			<div>
				<form>
					<div>
						<table id="jsonrpc-request-table">
							<tr>
								<td align=left><label>Method:</label></td>
								<td>
									<select id="method-select" onchange="createParamInputs()">
										{% for method in interface %}
										<option>{{	method.get("name") }}</option>
										{% endfor %}
									</select>
								</td>
							</tr>
						</table>
					</div>
				</form>
				<div>
					<pre class="jsonrpc-request" id="jsonrpc-request"></pre>
				</div>
				<button id="jsonrpc-execute-button" onclick="callJSONRPC()">Execute</button>
			</div>	

			<div id="result">
				<pre class="jsonrpc-result" id="jsonrpc-result"></pre>
			</div>
		</div>
	</div>
</body>
</html>