# docker build -f opsiconfd-41-Dockerfile -t opsiconfd41 .

FROM python:2.7-buster

ARG DOCKER_ENV

ENV DOCKER_ENV=${DOCKER_ENV} \
# python:
  PYTHONFAULTHANDLER=1 \
  PYTHONUNBUFFERED=1 \
  PYTHONHASHSEED=random \
  # pip:
  PIP_NO_CACHE_DIR=off \
  PIP_DISABLE_PIP_VERSION_CHECK=on \
  PIP_DEFAULT_TIMEOUT=100 \
  # dockerize:
  DOCKERIZE_VERSION=v0.6.1

# System deps:
RUN apt-get update \
	&& apt-get --yes dist-upgrade \
	&& apt-get --yes install \
		vim \
		wget \
		tini \
		psmisc

WORKDIR /tmp

RUN echo "deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.1:/stable/Debian_10/ /" > /etc/apt/sources.list.d/opsi.list \
	&& wget -nv https://download.opensuse.org/repositories/home:uibmz:opsi:4.1:stable/Debian_10/Release.key -O Release.key \
	&& apt-key add - < Release.key \
	&& apt-get update \
	&& mkdir -p /etc/opsi \
	&& touch /etc/opsi/opsiconfd.pem \
	&& DEBIAN_FRONTEND=noninteractive apt-get --yes install opsiconfd

COPY docker/files/ /

RUN echo "[session]" > /etc/opsi/opsiconfd.conf \
	&& echo "max sessions per ip = 2500" >> /etc/opsi/opsiconfd.conf \
	&& echo "[directories]" >> /etc/opsi/opsiconfd.conf \
	&& echo "/ = /usr/share/opsiconfd/static (noauth)" >> /etc/opsi/opsiconfd.conf \
	&& echo "configed = /usr/lib/configed (noauth)" >> /etc/opsi/opsiconfd.conf

RUN useradd --create-home --home-dir /home/adminuser -s /bin/bash adminuser \
	&& echo "adminuser:adminuser" | chpasswd \
	&& adduser adminuser pcpatch \
	&& adduser adminuser opsiadmin

RUN openssl req -nodes -x509 -newkey rsa:2048 -keyout ca.key -out ca.crt -subj "/C=DE/ST=RP/L=Mainz/O=uib/OU=root/CN=bonifax.uib.local/emailAddress=info@uib.de" \
	&& openssl req -nodes -newkey rsa:2048 -keyout server.key -out server.csr -subj "/C=DE/ST=RP/L=Mainz/O=uib/OU=opsiconfd/CN=bonifax.uib.local/emailAddress=info@uib.de" \
	&& openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt \
	&& mv server.key /etc/opsi/opsiconfd.pem \
	&& cat server.crt >> /etc/opsi/opsiconfd.pem \
	&& rm server.crt

##ENTRYPOINT ["/usr/bin/tini", "--", "/docker-entrypoint.sh"]
